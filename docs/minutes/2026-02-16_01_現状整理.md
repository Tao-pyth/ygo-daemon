# 現状整理メモ（2026-02-16 / 後任向け）

## 1. 現在の実装状況（確認結果）

本リポジトリは、`main.py` 単体で「定期実行型デーモン」の主要処理を実装しています。

- `checkDBVer` による更新検知を実施
- `KONAMI_ID` キューを最優先で消化
- APIレスポンスを JSONL に一時保存後、SQLite へバッチ取り込み
- `cards_raw.json` 列にカードJSONを丸ごと保存（ロスレス方針を維持）
- `cards_index` で検索用インデックスを保持

上記は「最低限の運用ループ」として成立しています。

---

## 2. 主要な課題（優先度つき）

## 優先度A（運用事故を防ぐために早急対応）

### A-1. 全件同期（offset/num + next_page_offset）の実行経路が未接続
- `ApiClient.cardinfo_fullsync_page()` は存在しますが、`run_once()` から呼ばれていません。
- 現状は `NEED_FETCH` からのキュー再取得に依存しており、「初回フル同期」や「ページング進行」が明確ではありません。
- 技術仕様の実行モデル（キュー空時に全件同期1ページ進める）との差分です。

**後任向け対応案**
- `kv_store` に `full_sync_offset` を持たせる
- キュー空時に `num/offset` で1ページ取得
- `meta.next_page_offset is null` で一巡完了を記録

### A-2. 取り込み失敗JSONLの退避先（`failed/`）未実装
- 現在は ingest 成否にかかわらず staging ファイルを削除しています。
- 仕様上は「失敗時に `failed/` へ移動し、再調査可能にする」方針が望ましいです。

**後任向け対応案**
- `data/staging/failed/` を作成
- ingest失敗時は `rename` で退避（時刻接尾辞付き）
- 成功時のみ削除

### A-3. ロック機構が単純ファイル存在判定のみ
- 異常終了時にロックファイルが残ると、次回以降ずっと `SKIP` になる可能性があります。

**後任向け対応案**
- PID/開始時刻を保存
- stale lock 判定（一定時間超過）または PID 生存確認

---

## 優先度B（品質・保守性改善）

### B-1. ログレベル設定の見直し余地
- ロガーは `INFO` ですが、ハンドラ側が `ERROR` のため通常運転ログがファイルに残りません。
- 監視や追跡の観点では、運用モードに応じた設定分離があると良いです。

### B-2. コメントと責務境界の追記が必要
- 処理自体は読みやすい一方、「なぜこの順序か」「どこが仕様上の重要点か」の注釈が少ない箇所があります。
- 今回、重要箇所へコメントを追記済み（`main.py`）。

---

## 3. 本日実施したこと

1. 現状分析メモを本ファイルとして新規作成。
2. 後任が誤読しやすい箇所（実行順序、再投入方針、全件同期未接続箇所）にコードコメントを追記。

---

## 4. 引き継ぎ時の注意点

- **最優先はデータ保全方針の維持**です。`cards_raw.json` の原本保存は崩さないでください。
- 仕様に寄せる改修は、
  1) 全件同期の接続、
  2) failed退避、
  3) ロックの堅牢化、
  の順で進めると安全です。
- 既存テーブルを変える場合は、`schema_version` の扱いと移行手順を必ずセットで残してください。

