# 現状整理メモ（2026-02-18 / 後任向け）

## 1. 本メモの目的

本メモは、現時点の `ygo-daemon` の**実装状況・課題・次の打ち手**を、後任プログラマが短時間で把握できるように整理したものです。  
「いま何ができていて、何が仕様との差分か」を明確化することを主眼にしています。

---

## 2. 現在の実装状況（確認結果）

### 2.1 実行フローの骨子

`main.py` の `run_once()` は、以下の順序で処理します。

1. ロック取得（重複実行の回避）
2. DB接続・マイグレーション適用
3. `checkDBVer` 実行
4. `dbver` 変化時は `cards_raw.fetch_status=NEED_FETCH` を設定
5. キュー処理（`PENDING` 優先、`ERROR` 再投入）
6. JSONL から SQLite へ取り込み
7. 画像ダウンロード
8. ロック解放

設計意図としては「1回の実行で少しだけ進める」方針を維持しています。

### 2.2 データ保存ポリシー

- カード原本 JSON は `cards_raw.json` に保存されており、ロスレス方針は維持されています。
- 差分判定には `content_hash`（安定化JSONのSHA-256）を利用しています。
- 検索向けの抜粋情報は `cards_index` に分離保存されています。

### 2.3 キュー機能

- `request_queue` は `konami_id` / `keyword` のどちらか一方を受け付ける設計です。
- 実運用ループではキュー優先処理が有効です。
- `ERROR` の再投入機構があり、単発失敗で永久停止しにくい実装になっています。

---

## 3. 仕様との差分・課題

## 優先度A（先に着手すべき課題）

### A-1. キュー空時の「offsetベース全件同期」が未接続

- 仕様では、キューが空の際に `num/offset` で全件同期を1ページ進める必要があります。
- 現在は「`NEED_FETCH` をキューへ戻す」までは実装済みですが、`meta.next_page_offset` を使った進行管理は未接続です。

**対応方針（提案）**

- `kv_store` に `full_sync_offset` / `full_sync_completed_at` を保持
- キュー空時に `cardinfo.php?num=...&offset=...&misc=yes` を1回だけ実行
- `next_page_offset is null` で1周完了を記録

### A-2. ingest失敗時の staging 退避 (`failed/`) 未実装

- 現在は ingest 成否に関わらず JSONL を削除しています。
- 失敗時の再解析ができず、障害調査コストが高くなります。

**対応方針（提案）**

- `data/staging/failed/` を作成
- `FAILED` 時は削除せず move する
- ファイル名にタイムスタンプを付与し、衝突を回避

### A-3. ロックの stale 対策不足

- ロックはファイル存在判定のみで、異常終了時に取り残される可能性があります。

**対応方針（提案）**

- ロックファイルに PID / 開始時刻 / ホスト名を記録
- 一定時間超過時の stale 判定を導入

## 優先度B（保守性・引き継ぎ性の課題）

### B-1. メインロジックが単一ファイルに集中

- `main.py` が大きく、API/Queue/Ingest/Image の責務が同居しています。
- 機能追加時の衝突・レビュー負荷が高くなりやすい構造です。

**対応方針（提案）**

- `app/` 配下へ段階分割（`api_client.py`, `queue_service.py`, `ingest_service.py`, `runner.py` など）
- 先にテストで現行挙動を固定し、分割時の退行を抑止

### B-2. コメントの不足（仕様背景の説明）

- 実装自体は読みやすいですが、"なぜこの順序なのか" の背景説明が不足しがちです。
- 今回、主要ファイルへ引き継ぎコメントを補強しています。

---

## 4. 今回の対応内容（2026-02-18）

1. 本メモ（`2026-02-18_01_現状整理.md`）を作成。
2. `README.md` を現行仕様に合わせて再整理（実行モデル・制約・既知課題を追記）。
3. 既存プログラム（`main.py`, `app/keyword_fetch.py`, `app/infra/migrate.py`）へ、後任向けコメントを追記。

---

## 5. 後任向けの推奨着手順

1. `A-1`（offset全件同期）を最優先で実装。
2. `A-2`（failed退避）を実装して障害調査性を確保。
3. `A-3`（stale lock対策）で運用停止リスクを低減。
4. その後、`main.py` 分割を段階実施（テスト同時更新）。

---

## 6. 注意事項

- `cards_raw.json` のロスレス保存は絶対に維持すること。
- `misc=yes` を外さないこと。
- キュー優先の順序は維持すること。
- 1回実行で大量処理に寄せすぎず、段階的進行の思想を守ること。

