# 技術仕様書

## YGOPRODeck API 定期同期デーモン

------------------------------------------------------------------------

## 文書情報

-   バージョン: 1.0.0
-   作成日: 2026-02-15

------------------------------------------------------------------------

# 1. 目的

YGOPRODeck API v7 を用いて遊戯王カード情報を取得し、\
`misc=yes` を含むレスポンスを
**ロスなく完全保存するデータ取得基盤を構築する。**

## 基本方針

1.  APIレスポンスJSONは加工せず丸ごと保存する。
2.  定期実行により少しずつ同期を進める。
3.  実行時は以下を必ず実施する：
    -   外部キュー（KONAMI_ID指定）を優先消化
    -   キューが空なら全件同期カーソルを進める
    -   取得JSONをSQLiteへ一括取り込み

------------------------------------------------------------------------

# 2. アーキテクチャ概要

Windows タスクスケジューラにより定期実行。

処理フロー：

1.  checkDBVer 実行
2.  外部キュー処理（KONAMI_ID）
3.  全件同期（num / offset）
4.  JSONL → SQLite 一括取り込み

------------------------------------------------------------------------

# 3. データ保存設計

## cards_raw（原本保存）

  カラム         型                    説明
  -------------- --------------------- -------------------
  card_id        INTEGER PRIMARY KEY   API id
  konami_id      INTEGER               KONAMI_ID
  json           TEXT NOT NULL         API生JSON
  content_hash   TEXT                  差分検知
  fetched_at     TEXT                  取得日時
  dbver_hash     TEXT                  更新判定
  source         TEXT                  queue / full_sync

## cards_index（検索用）

  カラム       型
  ------------ ---------------------
  card_id      INTEGER PRIMARY KEY
  konami_id    INTEGER
  name         TEXT
  type         TEXT
  race         TEXT
  attribute    TEXT
  level        INTEGER
  atk          INTEGER
  def          INTEGER
  archetype    TEXT
  ban_tcg      TEXT
  ban_ocg      TEXT
  updated_at   TEXT

------------------------------------------------------------------------

# 4. キュー仕様

request_queue は KONAMI_ID 検索を初期実装とする。

------------------------------------------------------------------------

# 5. 非機能要件

-   APIレート制御（1〜2 req/s）
-   排他ロック制御
-   再実行可能設計
-   JSON完全保存

------------------------------------------------------------------------

# 6. ロードマップ

## フェーズ1

-   SQLite設計
-   API取得処理
-   JSONL蓄積
-   一括取り込み

## フェーズ2

-   ログ整備
-   バックオフ強化
-   実行統計記録

## フェーズ3

-   差分抽出
-   圧縮保存
-   分析拡張

------------------------------------------------------------------------

# 確定事項

-   JSONはロスなく完全保存する
-   キュー検索はKONAMI_IDを初期実装とする
-   全件同期はoffsetカーソル方式
-   Neo4jは本仕様外とする
